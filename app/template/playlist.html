<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>music.prolikon.dev</title>
        <link
            rel="icon"
            type="image/png"
            href="/static/behelit.png"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        />
        <link
            rel="stylesheet"
            href="/static/output.css"
        />
    </head>

    <body class="bg-slate-950 text-white flex justify-center p-4 min-h-screen">
        <div class="w-full max-w-[1000px] flex flex-col gap-4">
            <div class="w-full flex items-center px-4 gap-2">
                <a id="download" onclick="downloadSelected()" class="bg-slate-900 rounded-full size-12 flex items-center justify-center p-2 hover:bg-lime-700 transition-colors"><i class="fa-solid fa-download"></i></a>
                <a id="request" onclick="requestSelectedAudios()" class="bg-slate-900 rounded-full size-12 flex items-center justify-center p-2 hover:bg-lime-700 transition-colors"><i class="fa-solid fa-hands-praying"></i></a>
                <a id="select_all" onclick="toggleSelectAll()" class="bg-slate-900 rounded-full size-12 flex items-center justify-center p-2 hover:bg-lime-700 transition-colors"><i class="fa-solid fa-layer-group"></i></a>
                <a id="select_dir" onclick="promptDir()" class="bg-slate-900 rounded-full h-12 min-w-12 flex items-center justify-center p-2 hover:bg-lime-700 transition-colors"><i class="fa-solid fa-folder"></i></a>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for video in videos %}
                    <div id="{{video.id}}" data-card data-state="{% if video.status==-1 %}download{% elif video.status==-2 %}request{% else %}in-progress{% endif %}"
                        class="card relative w-full flex items-start gap-4 bg-slate-900 p-2 rounded-lg shadow hover:scale-102 transition-[scale] outline-lime-700">
                        <img class="object-cover object-center size-16 rounded-md" src="https://img.youtube.com/vi/{{video.id}}/mqdefault.jpg">
                        <div class="flex flex-col h-full justify-between">
                            <div class="text-base font-semibold truncate">{{video.title}}</div>
                            <div class="text-xs text-gray-300">{{video.artist}}</div>
                            <div class="flex mt-1 mb-1 items-center gap-2 text-xs text-gray-500">Ready to download</div>
                        </div>
                        <a id="download-{{video_id}}" href="/static/media/{{video.id}}.mp3" class="download hidden
                            absolute bottom-2 right-2 bg-lime-700 rounded-full size-8 items-center justify-center p-2 hover:bg-white transition-colors">
                            <i class="fa-solid fa-download text-slate-900"></i>
                        </a>
                        <a id="processing-{{video_id}}" class="in-progress hidden spinner
                            absolute bottom-2 right-2 bg-amber-500 rounded-full size-8 items-center justify-center p-2 hover:bg-white transition-colors">
                            <i class="fa-solid fa-gear text-slate-900"></i>
                        </a>
                        <a id="request-{{video_id}}" onclick='requestAudio("{{video.id}}")' class="request hidden
                            absolute bottom-2 right-2 bg-red-800 rounded-full size-8 items-center justify-center p-2 hover:bg-white transition-colors">
                            <i class="fa-solid fa-hands-praying text-slate-900"></i>
                        </a>
                        <a class="complete hidden absolute bottom-2 right-2 bg-white rounded-full size-8 items-center justify-center p-2">
                            <i class="fa-solid fa-file-circle-check text-slate-900"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>

        <p>
            TODO: Check if maxresdefault is available and use others if needed
        </p>

        <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
        <script>
          const socket = io();

          let selectedIds = [];
          const download = document.getElementById("download");
          const request = document.getElementById("requeset");
          const selectAll = document.getElementById("select_all");
          const dirButton = document.getElementById("select_dir")
          const cards = document.querySelectorAll("[data-card]");

          let dirHandle;

          async function promptDir() {
            try {
              dirHandle = await window.showDirectoryPicker({id: "1", mode: "readwrite", startIn: "music"});
            } finally {
              dirButton.innerHTML = `&nbsp;<i class="fa-solid fa-folder-open"></i>&nbsp;${dirHandle.name}&nbsp;`

              for (const card of cards) {
                const fileName = `${card.id}.mp3`;

                try {
                  await dirHandle.getFileHandle(fileName);
                  card.dataset.state = "complete"
                } catch (err) {}
          } } }

          async function downloadSelected() {
            if (!dirHandle) {
                alert('Please select a folder first');
                return;
            }

            for (const id of selectedIds) {
                try {
                  downloadAudio(id)
                } catch (error) {
                    showError(`Failed to download ${id}`);
                }
            }
          }

          async function downloadAudio(id) {

              try {
                  // Fetch the video file
                  const response = await fetch(`/static/media/${id}.mp3`);
                  if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                  const videoData = await response.blob();

                  // Create file in the selected folder
                  const fileHandle = await dirHandle.getFileHandle(`${id}.mp3`, { create: true });
                  const writableStream = await fileHandle.createWritable();
                  await writableStream.write(videoData);
                  await writableStream.close();

                  let card = document.getElementById(id)
                  card.dataset.state = "complete"
                  console.log(`✅ Successfully saved ${id}`);
                  return true;
              } catch (error) {
                  throw new Error(`Download failed: ${error.message}`);
              }
          }

          // SOCKET //

          function requestAudio(id) {
            console.log("Requesting", id)
            socket.emit("request_audios", { video_id: [id] });
          }

          function requestSelectedAudios(id) {
            console.log("Requesting", selectedIds)
            socket.emit("request_audios", { video_id: selectedIds });
          }

          socket.on("tasks_enqueued", function (data) {
            if (data.type == "request_audio") {
              data.tasks.forEach(task => {
                let card = document.getElementById(task.video_id)
                if (card) {
                  card.dataset.state = "in-progress"
                }
              })
            }
          });

          socket.on("task_complete", data => {
            if (data.task == "request_audio") {
              let card = document.getElementById(data.video_id)
              if (card) {
                card.dataset.state = "download"
              }
            }
          });

          // HTML //

          function toggleCard(id) {
            const cards = Array.from(document.querySelectorAll("[data-card]"));
            const el = document.getElementById(id);
              if (selectedIds.includes(id)) {
                if (selectedIds.length === cards.length) {
                  selectAll.classList.add("bg-slate-900")
                  selectAll.classList.remove("bg-lime-700")
                }
                selectedIds = selectedIds.filter(x => x !== id);
                el.classList.remove("outline-3");
              } else {
                selectedIds.push(id);
                el.classList.add("outline-3");
                if (selectedIds.length === cards.length) {
                  selectAll.classList.remove("bg-slate-900")
                  selectAll.classList.add("bg-lime-700")
                }
              }
          }

          function toggleSelectAll() {
            const cards = Array.from(document.querySelectorAll("[data-card]"));

            if (selectedIds.length === cards.length) {
              // all selected → deselect all
              selectedIds = [];
              document.querySelectorAll("[data-card]").forEach(card => {
                if (!selectedIds.includes(card.id)) {
                  card.classList.remove("outline-3");
                }
              });
              selectAll.classList.add("bg-slate-900")
              selectAll.classList.remove("bg-lime-700")

            } else {
              // not all selected → select all
              selectedIds = cards.map(card => card.id);
              selectedIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add("outline-3");
              });
              selectAll.classList.remove("bg-slate-900")
              selectAll.classList.add("bg-lime-700")
            }
          }

          document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll("[data-card]").forEach(card => {
              card.addEventListener("click", (e) => {
                if (e.target.closest("a")) return;
                toggleCard(card.id);
              });
            });
          });

        </script>


    </body>
</html>
